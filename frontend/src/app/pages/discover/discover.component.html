<div class="discover-container">
  <h1>Discover Vehicles</h1>

  <nz-card nzTitle="Search Filters" class="filter-card">
    <form nz-form>
      <nz-row [nzGutter]="16">
        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Manufacturer</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select manufacturer"
                [(ngModel)]="searchFilters.manufacturer"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onManufacturerChange()">
                <nz-option
                  *ngFor="let mfr of manufacturers$ | async"
                  [nzValue]="mfr.name"
                  [nzLabel]="mfr.name + ' (' + mfr.vehicle_count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Model</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select model"
                [(ngModel)]="searchFilters.model"
                [ngModelOptions]="{standalone: true}"
                [nzDisabled]="!searchFilters.manufacturer"
                (ngModelChange)="onSearchChange()">
                <nz-option
                  *ngFor="let model of models$ | async"
                  [nzValue]="model.name"
                  [nzLabel]="model.name + ' (' + model.vehicle_count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Body Class</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select body class"
                [(ngModel)]="searchFilters.body_class"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onSearchChange()">
                <nz-option
                  *ngFor="let bc of (availableFilters$ | async)?.body_classes"
                  [nzValue]="bc.value"
                  [nzLabel]="bc.value + ' (' + bc.count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>

      <nz-row [nzGutter]="16">
        <nz-col [nzSpan]="24">
          <button nz-button nzType="primary" (click)="searchVehicles()">
            Search
          </button>
          <button nz-button (click)="clearFilters()" style="margin-left: 8px;">
            Clear
          </button>
        </nz-col>
      </nz-row>
    </form>
  </nz-card>

  <nz-card nzTitle="Search Results" [nzExtra]="extraTemplate" class="results-card">
    <ng-template #extraTemplate>
      <span *ngIf="pagination$ | async as pagination" style="color: rgba(0, 0, 0, 0.65);">
        Showing {{ getStartRecord(pagination) }}-{{ getEndRecord(pagination) }} of {{ pagination.total | number }} vehicles
      </span>
    </ng-template>

    <nz-table
      #vehicleTable
      [nzData]="(vehicles$ | async) || []"
      [nzLoading]="(loading$ | async) || false"
      [nzFrontPagination]="false"
      [nzPageSize]="(pagination$ | async)?.limit || 20"
      [nzTotal]="(pagination$ | async)?.total || 0"
      [nzPageIndex]="(pagination$ | async)?.page || 1"
      (nzPageIndexChange)="onPageChange($event)"
      [nzShowSizeChanger]="true"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzPageSizeOptions]="[10, 20, 50, 100]">
      <thead>
        <tr>
          <th>Vehicle ID</th>
          <th>Year</th>
          <th>Manufacturer</th>
          <th>Model</th>
          <th>Body Class</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let vehicle of vehicleTable.data">
          <td>{{ vehicle.vehicle_id }}</td>
          <td>{{ vehicle.year }}</td>
          <td>{{ vehicle.manufacturer }}</td>
          <td>{{ vehicle.model }}</td>
          <td>{{ vehicle.body_class || '-' }}</td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>
