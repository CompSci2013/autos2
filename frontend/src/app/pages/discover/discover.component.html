<div class="discover-container">
  <h1>Discover Vehicles</h1>

  <nz-card nzTitle="Search Filters" class="filter-card">
    <form nz-form>
      <nz-row [nzGutter]="16">
        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Manufacturer</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select manufacturer"
                [(ngModel)]="searchFilters.manufacturer"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onManufacturerChange()">
                <nz-option
                  *ngFor="let mfr of manufacturers$ | async; trackBy: trackByManufacturerName"
                  [nzValue]="mfr.name"
                  [nzLabel]="mfr.name + ' (' + mfr.vehicle_count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Model</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select model"
                [(ngModel)]="searchFilters.model"
                [ngModelOptions]="{standalone: true}"
                [nzDisabled]="!searchFilters.manufacturer"
                (ngModelChange)="onSearchChange()">
                <nz-option
                  *ngFor="let model of models$ | async; trackBy: trackByModelName"
                  [nzValue]="model.name"
                  [nzLabel]="model.name + ' (' + model.vehicle_count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Body Class</nz-form-label>
            <nz-form-control>
              <nz-select
                nzShowSearch
                nzAllowClear
                nzPlaceHolder="Select body class"
                [(ngModel)]="searchFilters.body_class"
                [ngModelOptions]="{standalone: true}"
                (ngModelChange)="onSearchChange()">
                <nz-option
                  *ngFor="let bc of (availableFilters$ | async)?.body_classes; trackBy: trackByBodyClassValue"
                  [nzValue]="bc.value"
                  [nzLabel]="bc.value + ' (' + bc.count + ')'">
                </nz-option>
              </nz-select>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>

      <nz-row [nzGutter]="16">
        <nz-col [nzSpan]="8">
          <nz-form-item>
            <nz-form-label>Year Range</nz-form-label>
            <nz-form-control>
              <div style="display: flex; gap: 8px; align-items: center;">
                <!-- From Year Dropdown -->
                <nz-select
                  nzShowSearch
                  nzAllowClear
                  nzPlaceHolder="From Year"
                  [(ngModel)]="searchFilters.year_min"
                  [ngModelOptions]="{standalone: true}"
                  (ngModelChange)="onYearRangeChange()"
                  style="width: 120px;">
                  <nz-option
                    *ngFor="let year of availableYears; trackBy: trackByYear"
                    [nzValue]="year"
                    [nzLabel]="year.toString()">
                  </nz-option>
                </nz-select>

                <span style="color: rgba(0,0,0,0.45);">to</span>

                <!-- To Year Dropdown -->
                <nz-select
                  nzShowSearch
                  nzAllowClear
                  nzPlaceHolder="To Year"
                  [(ngModel)]="searchFilters.year_max"
                  [ngModelOptions]="{standalone: true}"
                  (ngModelChange)="onYearRangeChange()"
                  style="width: 120px;">
                  <nz-option
                    *ngFor="let year of availableYears; trackBy: trackByYear"
                    [nzValue]="year"
                    [nzLabel]="year.toString()">
                  </nz-option>
                </nz-select>
              </div>

              <!-- Validation Warning -->
              <div
                *ngIf="searchFilters.year_min && searchFilters.year_max && searchFilters.year_min > searchFilters.year_max"
                style="color: #ff4d4f; margin-top: 4px; font-size: 12px;">
                <i nz-icon nzType="warning" nzTheme="fill"></i>
                "From Year" cannot be greater than "To Year"
              </div>

              <!-- Quick Decade Presets -->
              <nz-button-group style="margin-top: 8px;">
                <button nz-button nzSize="small" (click)="setYearRange(1950, 1959)">50s</button>
                <button nz-button nzSize="small" (click)="setYearRange(1960, 1969)">60s</button>
                <button nz-button nzSize="small" (click)="setYearRange(1970, 1979)">70s</button>
                <button nz-button nzSize="small" (click)="setYearRange(1980, 1989)">80s</button>
                <button nz-button nzSize="small" (click)="setYearRange(1990, 1999)">90s</button>
                <button nz-button nzSize="small" (click)="setYearRange(2000, 2009)">2000s</button>
              </nz-button-group>
            </nz-form-control>
          </nz-form-item>
        </nz-col>

        <nz-col [nzSpan]="16">
          <nz-form-item>
            <nz-form-label>&nbsp;</nz-form-label>
            <nz-form-control>
              <button nz-button (click)="clearFilters()">
                Clear Filters
              </button>
            </nz-form-control>
          </nz-form-item>
        </nz-col>
      </nz-row>
    </form>
  </nz-card>

  <nz-card nzTitle="Search Results" [nzExtra]="extraTemplate" class="results-card">
    <ng-template #extraTemplate>
      <span *ngIf="pagination$ | async as pagination" style="color: rgba(0, 0, 0, 0.65);">
        Showing {{ getStartRecord(pagination) }}-{{ getEndRecord(pagination) }} of {{ pagination.total | number }} vehicles
      </span>
    </ng-template>

    <nz-table
      #vehicleTable
      [nzData]="(vehicles$ | async) || []"
      [nzLoading]="(loading$ | async) || false"
      [nzFrontPagination]="false"
      [nzPageSize]="(pagination$ | async)?.limit || 20"
      [nzTotal]="(pagination$ | async)?.total || 0"
      [nzPageIndex]="(pagination$ | async)?.page || 1"
      (nzPageIndexChange)="onPageChange($event)"
      [nzShowSizeChanger]="true"
      (nzPageSizeChange)="onPageSizeChange($event)"
      [nzPageSizeOptions]="[10, 20, 50, 100]">
      <thead>
        <tr>
          <th>Vehicle ID</th>
          <th
            nzShowSort
            [nzSortOrder]="getSortOrder('year')"
            (nzSortOrderChange)="onSortChange('year', $event)"
            nzCustomFilter>
            <nz-filter-trigger [(nzVisible)]="yearFilterVisible" [nzActive]="searchFilters.year != null" [nzDropdownMenu]="yearFilterMenu">
              <i nz-icon nzType="filter" nzTheme="fill"></i>
            </nz-filter-trigger>
            Year
          </th>
          <th
            nzShowSort
            [nzSortOrder]="getSortOrder('manufacturer')"
            (nzSortOrderChange)="onSortChange('manufacturer', $event)"
            nzCustomFilter>
            <nz-filter-trigger [(nzVisible)]="manufacturerFilterVisible" [nzActive]="searchFilters.manufacturer != null" [nzDropdownMenu]="manufacturerFilterMenu">
              <i nz-icon nzType="filter" nzTheme="fill"></i>
            </nz-filter-trigger>
            Manufacturer
          </th>
          <th
            nzShowSort
            [nzSortOrder]="getSortOrder('model')"
            (nzSortOrderChange)="onSortChange('model', $event)"
            nzCustomFilter>
            <nz-filter-trigger [(nzVisible)]="modelFilterVisible" [nzActive]="searchFilters.model != null" [nzDropdownMenu]="modelFilterMenu">
              <i nz-icon nzType="filter" nzTheme="fill"></i>
            </nz-filter-trigger>
            Model
          </th>
          <th
            nzShowSort
            [nzSortOrder]="getSortOrder('body_class')"
            (nzSortOrderChange)="onSortChange('body_class', $event)"
            nzCustomFilter>
            <nz-filter-trigger [(nzVisible)]="bodyClassFilterVisible" [nzActive]="searchFilters.body_class != null" [nzDropdownMenu]="bodyClassFilterMenu">
              <i nz-icon nzType="filter" nzTheme="fill"></i>
            </nz-filter-trigger>
            Body Class
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let vehicle of vehicleTable.data; trackBy: trackByVehicleId">
          <td>{{ vehicle.vehicle_id }}</td>
          <td>{{ vehicle.year }}</td>
          <td>{{ vehicle.manufacturer }}</td>
          <td>{{ vehicle.model }}</td>
          <td>{{ vehicle.body_class || '-' }}</td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>
</div>

<!-- Filter Dropdown Menus -->
<nz-dropdown-menu #yearFilterMenu="nzDropdownMenu">
  <div class="filter-dropdown">
    <nz-select
      nzShowSearch
      nzAllowClear
      nzPlaceHolder="Select year"
      [(ngModel)]="searchFilters.year"
      (ngModelChange)="onSearchChange(); yearFilterVisible = false"
      style="width: 200px;">
      <nz-option
        *ngFor="let year of availableYears; trackBy: trackByYear"
        [nzValue]="year"
        [nzLabel]="year.toString()">
      </nz-option>
    </nz-select>
  </div>
</nz-dropdown-menu>

<nz-dropdown-menu #manufacturerFilterMenu="nzDropdownMenu">
  <div class="filter-dropdown">
    <nz-select
      nzShowSearch
      nzAllowClear
      nzPlaceHolder="Select manufacturer"
      [(ngModel)]="searchFilters.manufacturer"
      (ngModelChange)="onManufacturerChange(); manufacturerFilterVisible = false"
      style="width: 250px;">
      <nz-option
        *ngFor="let mfr of manufacturers$ | async; trackBy: trackByManufacturerName"
        [nzValue]="mfr.name"
        [nzLabel]="mfr.name">
      </nz-option>
    </nz-select>
  </div>
</nz-dropdown-menu>

<nz-dropdown-menu #modelFilterMenu="nzDropdownMenu">
  <div class="filter-dropdown">
    <nz-select
      nzShowSearch
      nzAllowClear
      nzPlaceHolder="Select model"
      [(ngModel)]="searchFilters.model"
      [nzDisabled]="!searchFilters.manufacturer"
      (ngModelChange)="onSearchChange(); modelFilterVisible = false"
      style="width: 250px;">
      <nz-option
        *ngFor="let model of models$ | async; trackBy: trackByModelName"
        [nzValue]="model.name"
        [nzLabel]="model.name">
      </nz-option>
    </nz-select>
  </div>
</nz-dropdown-menu>

<nz-dropdown-menu #bodyClassFilterMenu="nzDropdownMenu">
  <div class="filter-dropdown">
    <nz-select
      nzShowSearch
      nzAllowClear
      nzPlaceHolder="Select body class"
      [(ngModel)]="searchFilters.body_class"
      (ngModelChange)="onSearchChange(); bodyClassFilterVisible = false"
      style="width: 200px;">
      <nz-option
        *ngFor="let bc of (availableFilters$ | async)?.body_classes; trackBy: trackByBodyClassValue"
        [nzValue]="bc.value"
        [nzLabel]="bc.value">
      </nz-option>
    </nz-select>
  </div>
</nz-dropdown-menu>
